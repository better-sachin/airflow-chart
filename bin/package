#!/bin/sh
# Purpose: Package the airflow helm chart. If running in CircleCI release branch, append '-build####' to the version.
set -e

dest_dir="/tmp/airflow-chart-package"
rm -rf "${dest_dir}" || true
mkdir -p "${dest_dir}"

helm repo add stable https://kubernetes-charts.storage.googleapis.com
temp_dir=$(mktemp -d)

extra_args=()
if [[ "$CIRCLE_STAGE" == build-artifact-dev ]] ; then
  # build a version string like 0.1.2-build555 where 0.1.2 is the actual chart version and 555 is the CIRCLE_BUILD_NUM
  extra_args+=( --version "$(awk '$1 ~ /^version/ {printf "%s-build%s\n", $2, ENVIRON["CIRCLE_BUILD_NUM"]}' Chart.yaml)" )
fi

# helm uses the dir name as the package name
cp -R . "${temp_dir}/airflow"
cd "${temp_dir}"
helm package airflow --dependency-update --destination "$dest_dir" "${extra_args[@]}"
